<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:py="http://genshi.edgewall.org/"
      xmlns:xi="http://www.w3.org/2001/XInclude">
  <xi:include href="layout.html" />

  <head>
    <title>Create Code Review</title>
  </head>

  <body>

  <h1>Create a New Code Review</h1>

  <h2>Step 1: Choose a name for this review.</h2>

  <!-- CodeReview name is empty if new, with previous name is resubmitted -->
  <form method="post" action="${href.peerReviewNew()}" onsubmit="return validateInput(this);">
      <fieldset>
          Name: <input type="text" name="Name" MAXLENGTH="50" value="${name}" /><br />
      </fieldset>

    <h2 py:if="not followup">Step 2: Select the sections to be reviewed.</h2>
    <h2 py:if="followup">Step 2: Select the revision for the files.</h2>

    <p  py:if="followup" class="help">The selected revision is used for all files in the list. If you want to compare a file with a different revision
      you have to create a code review just for this file.</p>
    <!-- Displays the file browser -->
    <div id="repo_browser" data-is-followup="${followup or None}"></div>
    <div py:if="followup" id="follow-up-hint">
      <p class="help">You can't add files to the current review. You may use the source browser only for changing the
      revision and checking the files in the tree.</p>
    </div>
      <fieldset>
        <table class="listing dirlist" id="myfilelist">
          <thead>
            <tr>
              <th>Filename (Click to remove)</th>
              <th>Start Line</th>
              <th>End Line</th>
              <th py:if="followup">Old Revision</th>
              <th>Revision</th>
            </tr>
          </thead>
        <!-- Display an empty file list if it's a new CodeReview, display previous list if resubmitted -->
          <tbody py:if="new == 'yes'" id = "myfilebody">
            <tr id = "no-files" class="even">
              <td>No files have been added to the code review.</td>
              <td></td>
              <td></td>
              <td></td>
              <td py:if="followup"></td>
            </tr>
          </tbody>

          <tbody py:with="cls=cycle(('odd', 'even'))" id = "myfilebody">
            <tr py:for="item in prevFiles" id="${item.element_id}" class="${cls.next()}">
              <td>
                  <input type="hidden" name="file" value="${item.path},${item.version},${item.start},${item.end}"/>
                <a href="javascript:removefile('${item.path},${item.version},${item.start},${item.end}')">${item.path}</a>
              </td>
              <td>${item.start}</td>
              <td>${item.end}</td>
              <td>${item.version}</td>
              <td py:if="followup" class="newrev"></td>
            </tr>
          </tbody>
        </table>
      </fieldset>
    <h2>Step 3: Select reviewers for your review.</h2>

    <!-- Display a full reviewer drop-down list if it's a new CodeReview, display unassigned reviewers if resubmitted -->
    <py:choose test="new">
      <span py:when="'yes'">
        <select id="Reviewers">
          <option py:for="item in users" value="${item}">${item}</option>
        </select>
      </span>
      <span py:otherwise="">
        <py:choose test="emptyList">
          <span py:when="0">
            <select id="Reviewers">
              <option py:for="item in notPrevUsers" value="${item}">${item}</option>
            </select>
          </span>
          <span py:otherwise="">
            <select id="Reviewers">
              <option value="-1">--All users exhausted--</option>
            </select>
          </span>
        </py:choose>
      </span>
    </py:choose>

      <input disabled="${emptylist == 1 or None}" id="adduserbutton" type="button" onclick="adduser()" value="Add user" />

    <!-- Display an empty user list if it's a new CodeReview, display previous list if resubmitted -->
    <div py:choose="new">
        <table py:when="'yes'" class="listing" id="myuserlist">
          <thead>
            <tr>
              <td>Username (Click to remove)</td>
            </tr>
          </thead>
          <tbody id = "myuserbody">
            <tr id = "no-users" class="even">
              <td>No users have been added to the code review.</td>
            </tr>
          </tbody>
        </table>

        <table py:otherwise="" class="listing" id="myuserlist">
          <thead>
            <tr>
              <td>Username (Click to remove)</td>
            </tr>
          </thead>
          <tbody py:with="cls=cycle(('odd', 'even'))" id = "myuserbody">
            <tr py:for="item in prevUsers" id="${item}id" class="${cls.next()}">
              <td value="${item}">
                <input type="hidden" name="user" value="$item" />
                <a href="javascript:removeuser('${item}')">${item}</a>
              </td>
            </tr>
          </tbody>
        </table>
    </div>


    <h2>Step 4: Write general notes and instructions for the reviewers. (Optional)</h2>
    <fieldset>
      <p class="help">You may use wiki formating here.</p>
      <!-- Display an empty notes area if it's a new CodeReview, display previous notes if resubmitted -->
      <textarea name="Notes" cols="60" rows="8" py:content="notes"></textarea>
      <div class="buttons">
        <input py:if="oldid" type="hidden" name="oldid" value="$oldid" />
          <input py:if="not followup" type="submit" name="create" value="${new == 'yes' and 'Add Code Review' or 'Resubmit Code Review'}" />
          <input py:if="followup" type="hidden" name="followup" value="1" />
          <input py:if="followup" type="submit" name="createfollowup" value="${new == 'yes' and 'Add Code Review' or 'Add Followup Review'}" />
      </div>
    </fieldset>
  </form>

  <script type="text/javascript" src="${href.chrome('hw/js/peerReviewNew.js')}"/>

  </body>

</html>
