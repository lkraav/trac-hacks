{# Copyright (C) 2023 Dirk St√∂cker

  This software is licensed as described in the file COPYING, which
  you should have received as part of this distribution. The terms
  are also available at https://trac.edgewall.org/wiki/TracLicense.

  This software consists of voluntary contributions made by many
  individuals. For the exact contribution history, see the revision
  history and logs, available at https://trac.edgewall.org/.
#}
# extends 'admin.html'
<!DOCTYPE html>
<html>
  <head>
    <title>
      # block admintitle
      ${_("Edit Trac Settings (trac.ini)")}
      # endblock admintitle
    </title>
  </head>

  <body>
    # block adminpanel
    <h2>${_("Edit Trac Settings (trac.ini)")}</h2>

    <p class="help">
    # trans
    Allows you to edit the trac.ini file.<br/><i>Note:</i> To "delete" an option from the trac.ini file, just set it to its default value.
    # endtrans
    </p>

    <div class="toparea">
      <div id="select_section_form">
        <form method="post" action="">
          ${jmacros.form_token_input()}
          <fieldset>
            <legend>${_("Change Section")}</legend>
            <label>${_("Section name:")} 
              <select id="change-section-name" name="change-section" size="1">
                <option value=""${{'selected': len(sections) == 0}|htmlattr}>${_("select section")}</option>
                <option value="_all_sections"${{'selected': len(sections) > 1}|htmlattr}>${_("all sections")}</option>
                # for section_name in all_section_names:
                <option value="${section_name}"${{'selected': len(sections) == 1 and sections.keys()[0] == section_name}|htmlattr}>${section_name}</option>
                # endfor
              </select>
            </label>
            <input type="submit" value="${_('Show Section')}"/>
            <p class="help">${_("Warning: Changing the section discards all unsaved changes.")}</p>
          </fieldset>
        </form>
      </div>
    
      <div id="new_section_form">
        <form method="post" action="">
          ${jmacros.form_token_input()}
          <fieldset>
            <legend>${_("Add New Section")}</legend>
            <label>${_("Section name:")}
            <input type="text" name="new-section-name"/></label>
            <input type="submit" value="${_('Add Section')}"/>
            <p class="help">${_("Warning: Adding a new section discards all unsaved changes.")}</p>
          </fieldset>
        </form>
      </div>
    </div>
    # if len(sections) != 0:
    <div id="settings_table">
    <form method="post" action="">
      ${jmacros.form_token_input()}
      ## This field is used to enable auto detection which submit button was meant to be used. Works only with JavaScript enabled.
      <table class="listing" id="ini_settings_list">
        <thead>
          <tr>
            <th>${_("Name")}<input type="hidden" name="iniadmin_cur_focused_field" value=""/></th>
            <th>${_("Default")}</th>
            <th>${_("Value")}</th>
          </tr>
        </thead>
        <tbody>
          # for section_name, section in sections.items():
            <tr>
              <td colspan="3" class="section-title" id="section-title-${_fix(section_name)}">
                # if section.emptynote:
                <span class="editor-note">
                # trans
                <b>Note:</b> This section is essentially <b>empty and won't persist</b> unless a not-default value is specified for at least one option in this section.
                # endtrans
                </span>
                # endif
                <span class="section-name">[${section_name}]</span>
                <span class="section-info">${_("Options count:")} ${len(section)}</span>
                ## Add dummy field so that empty section won't get lost.
                <input type="hidden" name="iniadmin_value#${'#'}${_fix(section_name)}#${'#'}dummy" value="dummy"/>
              </td>
            </tr>
            # if descriptions.get(section_name):
            <tr class="collapsible-${_fix(section_name)} section-description">
              <td colspan="3">${wiki_to_html(context, descriptions[section_name])}</td>
            </tr>
            # endif
            # for access_level, access_level_options in (('modifiable', modifiable_options[section_name]), ('readonly', readonly_options[section_name])):
              # if len(access_level_options) != 0:
              <tr class="collapsible-${_fix(section_name)}">
                <td colspan="3" class="subsection-title">
                  ${access_level == 'modifiable' and _('Modifiable Options') or _('Read-only Options')}
                </td>
              </tr>
              # endif
              # for option_name, option in access_level_options.items():
                <tr class="collapsible-${_fix(section_name)}">
                  # if option.access != 'modifiable':
                  <td class="disabled">
                  # else:
                  <td>
                  # endif
                    <span class="nobr">${option_name}&nbsp;<span class="modification-indicator">(*)</span></span>
                  </td>
                  <td class="default">
                    <input type="checkbox" name="iniadmin_default" value="${section_name}#${'#'}${option_name}"${{'checked': option.value == option.default_value}|htmlattr}${{'disabled': option.access != 'modifiable'}|htmlattr}/>
                  </td>
                  <td>
                    # if option.type == "bool":
                    <span>
                      <label>
                        <input type="radio" name="iniadmin_value#${'#'}${section_name}#${'#'}${option_name}" value="true"${{'checked': option.value == 'true'}|htmlattr}${{'disabled': option.access != 'modifiable'}|htmlattr}/> 
                        ${_('true')}
                      </label>
                      <label>
                        <input type="radio" name="iniadmin_value#${'#'}${section_name}#${'#'}${option_name}" value="false"${{'checked': option.value != 'true'}|htmlattr}${{'disabled': option.access != 'modifiable'}|htmlattr}/> 
                        ${_('false')}
                      </label>
                    </span>
                    # elif option.type == "choice":
                    <select name="iniadmin_value#${'#'}${section_name}#${'#'}${option_name}">
                      # if option.access == "modifiable":
                        # for choice in option.option_info.choices:
                        <option value="${choice}"${{'selected': option.value == choice}|htmlattr}>${choice}</option>
                        # endfor
                      # else:
                      <option value="${option.value}" selected="true">${option.value}</option>
                      #endif
                    </select>
                    # elif option.type == "password":
                    ## NOTE: The value for password fields is intentionally empty so that passwords can't be found in the HTML code.
                    <input name="iniadmin_value#${'#'}${section_name}#${'#'}${option_name}" type="password" value="" 
                           class="option-value-field"${{'disabled': option.access != 'modifiable'}|htmlattr}/>
                    # else:
                    <input name="iniadmin_value#${'#'}${section_name}#${'#'}${option_name}" value="${option.value}" 
                           class="option-value-field"${{'disabled': option.access != 'modifiable'}|htmlattr}/>
                    # endif
                  </td>
                </tr>
                # if option.type == 'password':
                <tr class="collapsible-${_fix(section_name)} editor-note">
                  <td colspan="3">
                  # trans
                  <b>Note:</b> This option represents <b>a password</b>. Therefore the value of this field is intentionally empty. To change the password, simply enter it. To keep the current password keep this field empty."
                  # endtrans
                  </td>
                </tr>
                # endif
                # if option.option_info == None:
                <tr class="collapsible-${_fix(section_name)} editor-note">
                  <td colspan="3">
                  # trans
                  <b>Note:</b> This option is a <b>custom option</b>. It will be <b>completely deleted</b> if it's set to its default value. To keep it you need to assign a (non-empty) value to it.
                  # endtrans
                  </td>
                </tr>
                # endif
                <tr class="collapsible-${_fix(section_name)} option-info">
                  <td colspan="3">
                    # if option.desc:
                    <div class="option-description">${wiki_to_html(context, "**"+_("Description:")+"** " + option.desc)}</div>
                    # endif
                    <span class="value-info">
                      <b>${_("Type:")}</b> 
                      # if option.type == 'list':
                      <span>${_("list (separated by '%(separation)s')") % {'separation': option.option_info.sep[0]}}</span>
                      # elif option.type == 'path':
                      <span>${_("file system path")}</span>
                      # elif option.type == 'envrelativepath':
                      <span>${_("file system path relative to the Trac env")}</span>
                      # elif option.type == 'extension':
                      <span>${_("one component implementing '%(name)s'") % {'name': option.option_info.xtnpt.interface.__name__}}</span>
                      # elif option.type == 'orderedextensions':
                      <span>${_("ordered list of components implementing '%(name)s' (comma separated)") % {'name': option.option_info.xtnpt.interface.__name__}}</span>
                      # else:
                      ${_(option.type)}
                      # endif
                      | <b>${_("Access:")}</b> ${_(option.access)}
                      # if option.type == 'password':
                      <span>
                      | <b>${_("Default value:")}</b> ${option.default_value and _('<hidden>') or _('<none>')}
                      | <b>${_("Currently stored value:")}</b> ${option.stored_value and _('<hidden>') or _('<default value>')}
                      </span>
                      # else
                      <span>
                      | <b>${_("Default value:")}</b> ${option.default_value or _('<none>')} 
                      | <b>${_("Currently stored value:")}</b> ${(option.stored_value and option.stored_value != option.default_value and (len(unicode(option.stored_value)) < 100 and option.stored_value or (option.stored_value[:100] + '...'))) or _('<default value>')}
                      </span>
                      # endif
                    </span>
                  </td>
                </tr>
              # endfor
            # endfor
            # if len(hidden_options[section_name]) > 0:
            <tr class="collapsible-${_fix(section_name)}">
              <td colspan="3" class="subsection-title">${_("Hidden Options")}</td>
            </tr>
            <tr class="collapsible-${_fix(section_name)}">
              # if len(hidden_options[section_name]) == 1:
                <td colspan="3">${_("Due to security restrictions there is one option marked as hidden in this section.")}</td>
              # else:
                <td colspan="3">${_("Due to security restrictions there are %(options)s options marked as hidden in this section.") % {'options': hidden_options}}</td>
              # endif
            </tr>
            # endif
            <tr class="collapsible-${_fix(section_name)}">
              <td colspan="3">
                <input type="submit" name="iniadmin-submit-apply-${section_name}" value="${_('Apply changes')}" title="${_('Applies the changes from this section.')}"/>
                <input type="submit" name="iniadmin-submit-discard-${section_name}" value="${_('Discard changes')}" title="${_('Discards the changes from this section. Also removes custom options, if they still have their default value.')}"/>
                <span class="option-modify-section">
                  <input name="new-options-${section_name}" size="70" title="${_('Options to be added to this section; comma-separated')}"/>
                  <input type="submit" name="iniadmin-submit-addnewoptions-${section_name}" value="${_('Add options')}" title="${_('Adds the specified options to this section')}"/>
                </span>
              </td>
            </tr>
          # endfor
        </tbody>
      </table>
      # if len(sections) > 1:
      <div class="buttons">
        <input type="submit" name="iniadmin-submit-apply" value="${_('Apply changes')}" />
      </div>
      # endif
    </form>
    </div>
    # endif
    # endblock adminpanel
  </body>
</html>
