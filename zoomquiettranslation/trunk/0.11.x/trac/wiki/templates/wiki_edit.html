<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:xi="http://www.w3.org/2001/XInclude"
      xmlns:py="http://genshi.edgewall.org/"
      xmlns:i18n="http://genshi.edgewall.org/i18n">
  <xi:include href="layout.html" />
  <xi:include href="macros.html" />
  <head>
    <title>$title</title>
    <script type="text/javascript" src="${chrome.htdocs_location}js/wikitoolbar.js"></script>
    <script type="text/javascript">
      jQuery(document).ready(function($) {
        $("#text").blur(function() {
          $("#scroll_bar_pos").val(this.scrollTop);
        }).get(0).scrollTop = $("#scroll_bar_pos").val();
        $("#editrows").change(function() {
          resizeTextArea("text", this.options[this.selectedIndex].value);
        });
      });
    </script>
  </head>

  <body>
    <div id="content" class="wiki">

      <h1>编辑 ${name_of(page.resource)}</h1>
      <div py:if="merge" class="system-message">
        <p>已有其他人修改了该页面.</p><br />
        <p><b>如果你现在保存, 你将可能覆盖那些修改</b>
        (删除部分在下面高亮显示).</p><br />
        <p>请检查所有修改, 并手工合并到你的修改中. <br />
        如果你对所做的不确定, 请按 <tt>取消</tt>
        (失去你的修改) 然后重新开始编辑页面的最先版本.</p>
      </div>
      <py:choose test="action">
        <py:when test="'preview'">
          <table id="info" summary="Revision info">
            <tbody>
              <tr><th scope="col">
                改变未来版本的信息 ${page.version+1} (修改者 $author):
              </th></tr>
              <tr><td class="message" xml:space="preserve">
                ${wiki_to_html(context(page.resource(version=None)), comment)}
              </td></tr>
            </tbody>
          </table>
          <fieldset id="preview" py:choose="">
            <legend>${diff and 'Review Changes' or 'Preview'} (<a href="#edit">跳过</a>)</legend>
            <div py:when="diff" class="diff">
              <xi:include href="diff_div.html" py:with="no_id=True" />
            </div>
            <div py:otherwise="" class="wikipage" xml:space="preserve">
              ${wiki_to_html(context(page.resource), page.text)}
            </div>
          </fieldset>
        </py:when>
        <py:when test="'collision'">
          <div class="system-message">
            对不起, 该页面已经被其他人修改. 你不能保存所做的修改.
          </div>
        </py:when>
      </py:choose>
      <form id="edit" action="${href.wiki(page.name)}" method="post">
        <fieldset class="iefix">
          <input type="hidden" name="action" value="edit" />
          <input type="hidden" name="version" value="$page.version" />
          <input type="hidden" id="scroll_bar_pos" name="scroll_bar_pos"
                 value="$scroll_bar_pos" />
          <div id="rows">
            <label for="editrows">调整编辑框高度:</label>
            <select size="1" name="editrows" id="editrows" tabindex="43">
              <option py:for="rows in range(8, 42, 4)" value="$rows"
                      selected="${str(rows) == edit_rows or None}">
                $rows
              </option>
            </select>
          </div>
          <p><textarea id="text" class="wikitext" name="text" cols="80" rows="$edit_rows">
$page.text</textarea>
          </p>
        </fieldset>
        <div id="help" i18n:msg="">
          <b>注:</b> 参见 <a href="${href.wiki('WikiFormatting')}">WikiFormatting</a> 和
          <a href="${href.wiki('TracWiki')}">TracWiki</a> 以获得编辑维基内容的帮助
        </div>
        <fieldset id="changeinfo">
          <legend>修改信息</legend>
          <div id="changeinfo1">
            <div py:if="authname == 'anonymous'" class="field">
              <label>你的email或用户名:<br />
                <input id="author" type="text" name="author" size="30" value="$author" />
              </label>
            </div>
            <div class="field">
              <label>评论此次修改(可选):<br />
                <input id="comment" type="text" name="comment" size="60" value="$comment" />
              </label>
            </div>
          </div>
          <div py:if="'WIKI_ADMIN' in perm(page.resource)" id="changeinfo2" class="options">
            <label><input type="checkbox" name="readonly" id="readonly"
                          checked="${page.readonly or None}" />
              只读页面
            </label>
          </div>
        </fieldset>
        <div class="buttons" py:choose="action">
          <py:when test="'collision'">
            <input type="submit" name="preview" value="预览" disabled="disabled" />&nbsp;
            <input type="submit" name="merge" value="合并修改" accesskey="r" />&nbsp;
            <input type="submit" name="save" value="提交修改" disabled="disabled" />&nbsp;
          </py:when>
          <py:otherwise>
            <input type="submit" name="preview" value="预览页面" accesskey="r" />&nbsp;
            <input type="submit" name="diff" value="检查页面" accesskey="r" />&nbsp;
            <input type="submit" id="save" name="save" value="提交修改" />&nbsp;
          </py:otherwise>
          <input type="submit" name="cancel" value="取消" />
        </div>
      </form>
    </div>
  </body>
</html>
